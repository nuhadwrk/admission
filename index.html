<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Admission Form — Fill + Designer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>
  <!-- PDF.js (screen render) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script>pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';</script>
  <!-- pdf-lib (exact vector export/print) -->
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <style>
    :root { --ring: rgba(59,130,246,.35); }
    html, body { height: 100%; margin: 0; }
    body { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, 'Helvetica Neue', Arial; background: #f8fafc; }

    #chrome { max-width: 1100px; margin: 0 auto; padding: clamp(4px, 1vw, 8px); }

    #toolbar { 
      position: sticky; 
      top: 0; 
      z-index: 50; 
      display: flex; 
      flex-wrap: wrap; 
      gap: .25rem; 
      align-items: center; 
      padding: .3rem; 
      background: rgba(255,255,255,.96); 
      border: 1px solid #e5e7eb; 
      border-radius: 10px; 
      box-shadow: 0 4px 20px rgba(0,0,0,.08); 
      transition: transform 0.3s ease; 
    }
    #toolbar.hidden { transform: translateY(-100%); }

    #toggleToolbarBtn { 
      position: sticky; 
      top: 0; 
      z-index: 51; 
      margin: 4px auto; 
      padding: .4rem .8rem; 
      background: #2563eb; 
      color: #fff; 
      border: 1px solid #1d4ed8; 
      border-radius: 10px; 
      font-size: .9rem; 
      font-weight: 600; 
      cursor: pointer; 
      touch-action: manipulation; 
    }

    .btn { 
      display: inline-flex; 
      align-items: center; 
      justify-content: center; 
      gap: .3rem; 
      padding: .4rem .6rem; 
      border: 1px solid #e5e7eb; 
      border-radius: 8px; 
      background: #fff; 
      color: #0f172a; 
      font-weight: 600; 
      font-size: .85rem; 
      touch-action: manipulation; 
      pointer-events: auto; 
    }
    .btn-primary { background: #2563eb; color: #fff; border-color: #1d4ed8; }

    .select-container {
      display: flex;
      align-items: center; 
      gap: .3rem; 
      border: 1px solid #e5e7eb; 
      border-radius: 8px; 
      background: #fff; 
      padding: .3rem .6rem; 
      font-size: .85rem; 
      min-height: 30px; /* Larger tap area */
    }
    select { 
      outline: none; 
      background: transparent; 
      font-size: .85rem; 
      padding: .2rem; 
      touch-action: manipulation; 
      pointer-events: auto; 
      min-width: 50px; /* Easier to tap */
    }

    #stage { 
      background: #fff; 
      border: 1px solid #e5e7eb; 
      border-radius: 16px; 
      padding: clamp(4px, 1vw, 8px); 
      margin-top: 4px; 
    }
    #pages { 
      display: flex; 
      flex-direction: column; 
      gap: clamp(8px, 1.5vw, 12px); 
      align-items: center; 
      padding-bottom: 16px; 
    }

    .page { position: relative; }
    .page canvas { display: block; border-radius: 0; box-shadow: 0 4px 12px rgba(0,0,0,.06); }

    .box { 
      position: absolute; 
      background: transparent; 
      color: #0f172a; 
      min-width: 25px; 
      min-height: 16px; 
      border-radius: 5px; 
      padding: 2px 4px; 
      line-height: 1.2; 
      outline: none; 
      overflow: hidden; 
      white-space: pre-wrap; 
      -webkit-user-select: text; 
      user-select: text; 
      font-size: clamp(10px, 2.5vw, 12px); 
      touch-action: manipulation; 
    }
    body.design .box { resize: both; border: 1px dashed transparent; }
    body.design .box.sel { border-color: #3b82f6; box-shadow: 0 0 0 3px var(--ring); background: rgba(255,255,255,.9); }
    body:not(.design) .box { resize: none; }
    .box:focus { box-shadow: 0 0 0 3px var(--ring); background: rgba(255,255,255,.85); }

    @media print { 
      body { background: #fff; } 
      #chrome > *:not(#stage) { display: none !important; } 
      #stage { border: 0; padding: 0; margin: 0; } 
      .page canvas { box-shadow: none; } 
    }
    @media (max-width: 640px) {
      #chrome { padding: 4px; }
      #toolbar { 
        flex-direction: column; 
        align-items: stretch; 
        padding: .2rem; 
        gap: .1rem; 
        border-radius: 8px; 
      }
      .btn { 
        padding: .3rem .5rem; 
        font-size: .8rem; 
      }
      .select-container {
        padding: .2rem .5rem; 
        font-size: .8rem; 
        min-height: 35px; /* Larger for touch */
      }
      select { 
        font-size: .8rem; 
        padding: .15rem; 
        min-width: 60px; 
      }
      /* Hide non-essential controls by default, show in expanded mode */
      #delFieldBtn, #dupFieldBtn, #fieldName, #applyNameBtn, 
      #saveAnchorsBtn, #loadAnchorsBtn, #importAnchorsInput, #exportAnchorsBtn { 
        display: none; 
      }
      #toolbar.expanded #delFieldBtn, #toolbar.expanded #dupFieldBtn, 
      #toolbar.expanded #fieldName, #toolbar.expanded #applyNameBtn, 
      #toolbar.expanded #exportAnchorsBtn { 
        display: flex; 
      }
      #fieldName { width: 6rem; }
      #stage { 
        padding: 4px; 
        margin-top: 2px; 
        border-radius: 12px; 
      }
      .page canvas { box-shadow: 0 2px 8px rgba(0,0,0,.05); }
      .box { 
        min-width: 20px; 
        min-height: 14px; 
        padding: 2px 3px; 
        font-size: clamp(8px, 2vw, 10px); 
      }
      #toggleToolbarBtn { 
        display: block; /* Always show on mobile */
      }
    }
  </style>
</head>
<body class="fill min-h-screen">
  <div id="chrome" class="space-y-2">
    <header class="text-center">
      <h1 class="text-xl font-extrabold tracking-tight text-slate-900">Admission Form</h1>
      <p class="text-slate-600 text-xs">Mobile-first form filler with designer</p>
    </header>

    <div id="toolbar">
      <div class="select-container">
        <span class="text-slate-600">Mode</span>
        <select id="modeSel" class="outline-none bg-transparent">
          <option value="fill" selected>Fill</option>
          <option value="design">Design</option>
        </select>
      </div>

      <button id="addFieldBtn" class="btn" title="Add field; tap page to place">+ Field</button>
      <button id="delFieldBtn" class="btn" title="Delete selected">Delete</button>
      <button id="dupFieldBtn" class="btn" title="Duplicate selected">Duplicate</button>

      <div class="select-container">
        <span class="text-slate-600">Font pt</span>
        <select id="fontSizeSel" class="outline-none bg-transparent">
          <option>8</option><option>10</option><option>12</option>
          <option selected>14</option><option>16</option><option>18</option><option>20</option>
        </select>
      </div>
      <div class="select-container">
        <span class="text-slate-600">Line</span>
        <select id="lineHeightSel" class="outline-none bg-transparent">
          <option>1.0</option><option>1.1</option><option selected>1.2</option>
          <option>1.3</option><option>1.4</option><option>1.5</option><option>1.6</option><option>1.8</option><option>2.0</option>
        </select>
      </div>
      <div class="flex items-center gap-1 border border-slate-200 rounded-lg bg-white px-1.5 py-0.5 text-xs">
        <span class="text-slate-600">Name</span>
        <input id="fieldName" class="w-24 outline-none" placeholder="patient_name" />
        <button id="applyNameBtn" class="btn">Apply</button>
      </div>

      <div class="w-px h-5 bg-slate-200 mx-1"></div>

      <button id="saveAnchorsBtn" class="btn" title="Save anchors (browser)">Save</button>
      <button id="loadAnchorsBtn" class="btn" title="Load anchors (browser)">Load</button>
      <button id="exportAnchorsBtn" class="btn btn-primary" title="Download anchors JSON">Export JSON</button>
      <label class="btn" id="importAnchorsInput" title="Import anchors JSON">
        <input type="file" accept="application/json" class="hidden" />
        Import JSON
      </label>

      <div class="w-px h-5 bg-slate-200 mx-1"></div>

      <button id="printBtn" class="btn" title="Print">Print</button>
      <button id="exportBtn" class="btn btn-primary" title="Export filled PDF">Export PDF</button>

      <span id="saveBadge" class="ml-auto text-xs px-1.5 py-0.5 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-200 hidden">Saved</span>
    </div>

    <button id="toggleToolbarBtn">Show Toolbar</button>

    <div id="stage" class="relative rounded-2xl border border-slate-200 bg-white">
      <div id="pages"></div>
      <div id="overlay" class="absolute inset-0 flex items-center justify-center text-slate-600 bg-white/70 rounded-2xl">Loading…</div>
    </div>
  </div>

  <script>
    // ====== CONFIG ======
    const PDF_URL = 'https://raw.githubusercontent.com/nuhadwrk/admission/main/Admission.pdf';

    // ====== Elements ======
    const modeSel = document.getElementById('modeSel');
    const addFieldBtn = document.getElementById('addFieldBtn');
    const delFieldBtn = document.getElementById('delFieldBtn');
    const dupFieldBtn = document.getElementById('dupFieldBtn');
    const fontSizeSel = document.getElementById('fontSizeSel');
    const lineHeightSel = document.getElementById('lineHeightSel');
    const fieldNameInput = document.getElementById('fieldName');
    const applyNameBtn = document.getElementById('applyNameBtn');
    const saveAnchorsBtn = document.getElementById('saveAnchorsBtn');
    const loadAnchorsBtn = document.getElementById('loadAnchorsBtn');
    const exportAnchorsBtn = document.getElementById('exportAnchorsBtn');
    const importAnchorsInput = document.querySelector('#importAnchorsInput input');
    const printBtn = document.getElementById('printBtn');
    const exportBtn = document.getElementById('exportBtn');
    const toggleToolbarBtn = document.getElementById('toggleToolbarBtn');
    const toolbar = document.getElementById('toolbar');
    const stage = document.getElementById('stage');
    const pagesRoot = document.getElementById('pages');
    const overlay = document.getElementById('overlay');
    const saveBadge = document.getElementById('saveBadge');

    // ====== State ======
    let pdfDoc = null;
    let fileKey = 'Admission';
    let adding = false;
    let selected = null;
    let anchorsByPage = {};
    let values = {};
    let currentScale = 1;
    let currentDPR = Math.min(window.devicePixelRatio || 1, 1.5);
    let lastStageW = 0;

    // ====== Toolbar Toggle ======
    function toggleToolbar() {
      toolbar.classList.toggle('hidden');
      toolbar.classList.toggle('expanded', !toolbar.classList.contains('hidden'));
      toggleToolbarBtn.textContent = toolbar.classList.contains('hidden') ? 'Show Toolbar' : 'Hide Toolbar';
      localStorage.setItem('toolbarState:' + fileKey, toolbar.classList.contains('hidden') ? 'hidden' : 'visible');
    }

    toggleToolbarBtn.addEventListener('click', toggleToolbar);

    // ====== Helpers ======
    function setEnabled(enabled) {
      [addFieldBtn, delFieldBtn, dupFieldBtn, saveAnchorsBtn, loadAnchorsBtn, exportAnchorsBtn, printBtn, exportBtn, applyNameBtn].forEach(b => b.disabled = !enabled);
      refreshBoxesInteractivity();
    }

    function storageKey() { return 'anchors:' + fileKey; }

    function download(filename, data, type = 'application/json') {
      const blob = new Blob([data], { type });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
      setTimeout(() => URL.revokeObjectURL(a.href), 5000);
    }

    function showSavedBadge() {
      saveBadge.classList.remove('hidden');
      clearTimeout(showSavedBadge._t);
      showSavedBadge._t = setTimeout(() => saveBadge.classList.add('hidden'), 1200);
    }

    function getLineHeightRatio(el) {
      const inline = parseFloat(el.style.lineHeight);
      if (!isNaN(inline) && inline > 0) return inline;
      const cs = getComputedStyle(el);
      const lhPx = parseFloat(cs.lineHeight);
      const fsPx = parseFloat(cs.fontSize) || 14;
      return !isNaN(lhPx) && !isNaN(fsPx) && fsPx > 0 ? lhPx / fsPx : 1.2;
    }

    function refreshBoxesInteractivity() {
      document.querySelectorAll('.box').forEach(tb => {
        tb.style.resize = (modeSel.value === 'design') ? 'both' : 'none';
      });
    }

    // ====== Scale + Render ======
    async function renderAllPages() {
      const cs = getComputedStyle(stage);
      const padX = parseFloat(cs.paddingLeft) + parseFloat(cs.paddingRight);
      const stageWExact = Math.max(stage.clientWidth - padX, 280);
      if (Math.abs(stageWExact - lastStageW) < 5) return;
      lastStageW = stageWExact;

      pagesRoot.innerHTML = '';
      const page1 = await pdfDoc.getPage(1);
      const v1 = page1.getViewport({ scale: 1 });
      currentScale = stageWExact / v1.width;
      currentDPR = Math.min(window.devicePixelRatio || 1, 1.5);

      for (let p = 1; p <= pdfDoc.numPages; p++) {
        const page = await pdfDoc.getPage(p);
        const vpCSS = page.getViewport({ scale: currentScale });
        const vpHiDPI = page.getViewport({ scale: currentScale * currentDPR });

        const pageWrap = document.createElement('div');
        pageWrap.className = 'page';
        pageWrap.dataset.page = String(p);
        pageWrap.style.width = vpCSS.width + 'px';
        pageWrap.style.height = vpCSS.height + 'px';

        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = Math.round(vpHiDPI.width);
        canvas.height = Math.round(vpHiDPI.height);
        canvas.style.width = vpCSS.width + 'px';
        canvas.style.height = vpCSS.height + 'px';

        pageWrap.appendChild(canvas);
        pagesRoot.appendChild(pageWrap);
        await page.render({ canvasContext: ctx, viewport: vpHiDPI }).promise;

        (anchorsByPage[p] || []).forEach(a => spawnBox(p, a));
      }
      overlay?.remove?.();
      refreshBoxesInteractivity();
    }

    function toScreen(a, cw, ch) {
      return { left: a.x * cw, top: a.y * ch, width: a.w * cw, height: a.h * ch };
    }

    function spawnBox(pageNo, a) {
      const pageWrap = [...pagesRoot.children].find(el => el.dataset.page == String(pageNo));
      if (!pageWrap) return;
      const tb = document.createElement('div');
      tb.className = 'box';
      tb.contentEditable = true;
      tb.dataset.page = String(pageNo);
      tb.dataset.name = a.name || '';

      const fpt = a.fpt || 14;
      tb.style.fontSize = (fpt * currentScale) + 'px';
      tb.style.lineHeight = (a.lh || 1.2).toString();

      const s = toScreen(a, pageWrap.clientWidth, pageWrap.clientHeight);
      tb.style.left = s.left + 'px';
      tb.style.top = s.top + 'px';
      tb.style.width = s.width + 'px';
      tb.style.height = s.height + 'px';
      tb.textContent = values[a.name || ''] || '';

      tb.addEventListener('input', () => {
        const k = tb.dataset.name;
        if (k) values[k] = tb.textContent;
        autoSaveValues();
      });

      tb.addEventListener('pointerdown', (e) => {
        if (modeSel.value !== 'design') return;
        tb.classList.add('sel');
        selected = tb;
        tb.setPointerCapture(e.pointerId);
        tb._drag = true;
        tb._sx = e.clientX;
        tb._sy = e.clientY;
        tb._sl = parseFloat(tb.style.left) || 0;
        tb._st = parseFloat(tb.style.top) || 0;
        fieldNameInput.value = tb.dataset.name || '';
        fontSizeSel.value = String(Math.round(fpt));
        lineHeightSel.value = (Math.round(getLineHeightRatio(tb) * 10) / 10).toFixed(1);
      });
      tb.addEventListener('pointermove', (e) => {
        if (modeSel.value !== 'design' || !tb._drag) return;
        const dx = e.clientX - tb._sx, dy = e.clientY - tb._sy;
        tb.style.left = (tb._sl + dx) + 'px';
        tb.style.top = (tb._st + dy) + 'px';
      });
      tb.addEventListener('pointerup', () => { tb._drag = false; autoSaveAnchors(); });
      tb.addEventListener('click', (e) => e.stopPropagation());
      tb.addEventListener('blur', () => {
        const k = tb.dataset.name;
        if (k) values[k] = tb.textContent;
        autoSaveValues();
      });

      pageWrap.appendChild(tb);
      return tb;
    }

    function getAnchorsFromDom() {
      const out = {};
      [...pagesRoot.children].forEach(pageWrap => {
        const p = parseInt(pageWrap.dataset.page);
        const cw = pageWrap.clientWidth, ch = pageWrap.clientHeight;
        const list = [...pageWrap.querySelectorAll('.box')].map(tb => {
          const fpt = parseFloat(tb.style.fontSize) / currentScale || 14;
          return {
            name: tb.dataset.name || '',
            x: (parseFloat(tb.style.left) || 0) / cw,
            y: (parseFloat(tb.style.top) || 0) / ch,
            w: tb.offsetWidth / cw,
            h: tb.offsetHeight / ch,
            lh: getLineHeightRatio(tb),
            fpt
          };
        });
        out[p] = list;
      });
      return out;
    }

    function selectBox(tb) {
      document.querySelectorAll('.box').forEach(b => b.classList.remove('sel'));
      selected = tb;
      if (tb) tb.classList.add('sel');
    }

    function deleteSelected() {
      if (!selected) return;
      selected.remove();
      selected = null;
      autoSaveAnchors();
    }

    function duplicateSelected() {
      if (!selected) return;
      const pageWrap = selected.closest('.page');
      const p = parseInt(pageWrap.dataset.page);
      const cw = pageWrap.clientWidth, ch = pageWrap.clientHeight;
      const fpt = parseFloat(selected.style.fontSize) / currentScale || 14;
      const a = {
        name: (selected.dataset.name || '') + '_copy',
        x: (parseFloat(selected.style.left) || 0) / cw + 0.02,
        y: (parseFloat(selected.style.top) || 0) / ch + 0.02,
        w: selected.offsetWidth / cw,
        h: selected.offsetHeight / ch,
        lh: getLineHeightRatio(selected),
        fpt
      };
      a.x = Math.min(a.x, 0.95);
      a.y = Math.min(a.y, 0.95);
      anchorsByPage[p] = anchorsByPage[p] || [];
      anchorsByPage[p].push(a);
      spawnBox(p, a);
      autoSaveAnchors();
    }

    function applyName() {
      if (!selected) return;
      const name = fieldNameInput.value.trim();
      if (!name) return alert('Field name cannot be empty.');
      if (Object.keys(values).includes(name)) return alert('Field name already exists.');
      selected.dataset.name = name;
      if (!values[name]) values[name] = '';
      autoSaveAnchors();
    }

    function applyFontSize() {
      if (!selected) {
        console.log('applyFontSize: No box selected');
        return;
      }
      const fontSize = parseFloat(fontSizeSel.value);
      if (isNaN(fontSize)) {
        console.error('applyFontSize: Invalid font size');
        return;
      }
      selected.style.fontSize = (fontSize * currentScale) + 'px';
      console.log('applyFontSize: Set font-size to', selected.style.fontSize, 'for box', selected.dataset.name);
      autoSaveAnchors();
    }

    function applyLineHeight() {
      if (!selected) {
        console.log('applyLineHeight: No box selected');
        return;
      }
      const lineHeight = parseFloat(lineHeightSel.value);
      if (isNaN(lineHeight)) {
        console.error('applyLineHeight: Invalid line height');
        return;
      }
      selected.style.lineHeight = lineHeight.toString();
      console.log('applyLineHeight: Set line-height to', selected.style.lineHeight, 'for box', selected.dataset.name);
      autoSaveAnchors();
    }

    // ===== Local persistence =====
    function saveAnchors() {
      anchorsByPage = getAnchorsFromDom();
      const payload = { anchorsByPage, version: 4 };
      localStorage.setItem(storageKey(), JSON.stringify(payload));
      showSavedBadge();
    }

    function loadAnchors() {
      const raw = localStorage.getItem(storageKey());
      if (!raw) return alert('No saved anchors for this file.');
      try {
        const p = JSON.parse(raw);
        anchorsByPage = p.anchorsByPage || {};
        renderAllPages();
        showSavedBadge();
      } catch (e) {
        alert('Failed to parse anchors JSON.');
      }
    }

    function exportAnchors() {
      const data = JSON.stringify({ anchorsByPage, version: 4 }, null, 2);
      download(fileKey + '-anchors.json', data);
    }

    function autoSaveAnchors() {
      clearTimeout(autoSaveAnchors._t);
      autoSaveAnchors._t = setTimeout(saveAnchors, 350);
    }

    function autoSaveValues() {
      clearTimeout(autoSaveValues._t);
      autoSaveValues._t = setTimeout(() => {
        localStorage.setItem('values:' + fileKey, JSON.stringify(values));
        showSavedBadge();
      }, 400);
    }

    importAnchorsInput.addEventListener('change', async (e) => {
      const f = e.target.files?.[0];
      if (!f) return;
      const text = await f.text();
      try {
        const p = JSON.parse(text, (key, value) => {
          if (key === '__proto__' || key === 'constructor') return undefined;
          return value;
        });
        anchorsByPage = p.anchorsByPage || {};
        await renderAllPages();
        showSavedBadge();
      } catch (err) {
        alert('Invalid or malicious JSON');
      }
    });

    // ===== Enhanced Text Wrapping =====
    function wrapTextBlocks(text) {
      return text.replace(/\r/g, '').split('\n');
    }

    function wrapLineToWidth(text, font, size, maxWidth) {
      const words = text.split(/\s+/);
      const lines = [];
      let line = '';
      const W = t => font.widthOfTextAtSize(t, size);
      for (const w of words) {
        const t = line ? line + ' ' + w : w;
        if (W(t) <= maxWidth) {
          line = t;
        } else {
          if (line) lines.push(line);
          if (W(w) > maxWidth) {
            let charLine = '';
            for (const c of w) {
              const t = charLine + c;
              if (W(t) <= maxWidth) {
                charLine = t;
              } else {
                if (charLine) lines.push(charLine);
                charLine = c;
              }
            }
            if (charLine) line = charLine;
            else line = '';
          } else {
            line = w;
          }
        }
      }
      if (line) lines.push(line);
      return lines;
    }

    async function buildPdfBlob() {
      const pdfBytes = await fetch(PDF_URL).then(r => r.arrayBuffer());
      const pdf = await PDFLib.PDFDocument.load(pdfBytes);
      const font = await pdf.embedFont(PDFLib.StandardFonts.Helvetica);

      for (let p = 1; p <= pdf.getPageCount(); p++) {
        const page = pdf.getPages()[p - 1];
        const { width, height } = page.getSize();
        const list = anchorsByPage[p] || [];
        list.forEach(a => {
          const name = a.name || '';
          const text = (values[name] || '').toString();
          if (!text) return;
          const fpt = a.fpt || 14;
          const lh = a.lh || 1.2;
          const pad = 2;
          const boxW = a.w * width - pad * 2;
          const boxH = a.h * height - pad * 2;
          const startX = a.x * width + pad;
          const topY = height - (a.y * height) - pad;

          const blocks = wrapTextBlocks(text);
          let y = topY - fpt;
          outer: for (const b of blocks) {
            const lines = wrapLineToWidth(b, font, fpt, boxW);
            for (const ln of lines) {
              if ((topY - y) > boxH + fpt * 0.2) break outer;
              page.drawText(ln, { x: startX, y, size: fpt, font, color: PDFLib.rgb(0, 0, 0) });
              y -= fpt * lh;
            }
            y -= fpt * (lh - 1);
          }
        });
      }
      const outBytes = await pdf.save();
      return new Blob([outBytes], { type: 'application/pdf' });
    }

    async function doExport() {
      const blob = await buildPdfBlob();
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = fileKey + '-filled.pdf';
      a.click();
      setTimeout(() => URL.revokeObjectURL(a.href), 5000);
    }

    async function doPrint() {
      const blob = await buildPdfBlob();
      const url = URL.createObjectURL(blob);
      const iframe = document.createElement('iframe');
      iframe.style.position = 'fixed';
      iframe.style.right = '0';
      iframe.style.bottom = '0';
      iframe.style.width = '0';
      iframe.style.height = '0';
      iframe.style.border = '0';
      document.body.appendChild(iframe);
      iframe.onload = () => {
        setTimeout(() => {
          try {
            iframe.contentWindow.focus();
            iframe.contentWindow.print();
          } catch {}
        }, 300);
      };
      iframe.src = url;
      setTimeout(() => URL.revokeObjectURL(url), 15000);
    }

    // ===== Events =====
    pagesRoot.addEventListener('click', (e) => {
      const tb = e.target.closest('.box');
      selectBox(tb || null);
    });

    addFieldBtn.addEventListener('click', () => {
      if (!pdfDoc || modeSel.value !== 'design') return;
      adding = true;
      document.body.style.cursor = 'crosshair';
    });

    delFieldBtn.addEventListener('click', deleteSelected);
    dupFieldBtn.addEventListener('click', duplicateSelected);
    applyNameBtn.addEventListener('click', applyName);
    fontSizeSel.addEventListener('change', applyFontSize);
    lineHeightSel.addEventListener('change', applyLineHeight);
    saveAnchorsBtn.addEventListener('click', saveAnchors);
    loadAnchorsBtn.addEventListener('click', loadAnchors);
    exportAnchorsBtn.addEventListener('click', exportAnchors);
    printBtn.addEventListener('click', doPrint);
    exportBtn.addEventListener('click', doExport);

    modeSel.addEventListener('change', () => {
      document.body.classList.toggle('design', modeSel.value === 'design');
      fontSizeSel.disabled = modeSel.value !== 'design';
      lineHeightSel.disabled = modeSel.value !== 'design';
      refreshBoxesInteractivity();
    });

    pagesRoot.addEventListener('click', (e) => {
      if (!adding || modeSel.value !== 'design') return;
      const pageWrap = e.target.closest('.page');
      if (!pageWrap) return;
      const r = pageWrap.getBoundingClientRect();
      const x = (e.clientX - r.left) / r.width;
      const y = (e.clientY - r.top) / r.height;
      const a = {
        name: '',
        x: Math.max(0, Math.min(1, x - 0.15)),
        y: Math.max(0, Math.min(1, y - 0.03)),
        w: 0.3,
        h: 0.06,
        lh: parseFloat(lineHeightSel.value) || 1.2,
        fpt: parseFloat(fontSizeSel.value) || 14
      };
      const p = parseInt(pageWrap.dataset.page);
      anchorsByPage[p] = anchorsByPage[p] || [];
      anchorsByPage[p].push(a);
      spawnBox(p, a);
      adding = false;
      document.body.style.cursor = 'default';
      autoSaveAnchors();
    });

    let _resizeTO = null;
    window.addEventListener('resize', () => {
      if (!pdfDoc) return;
      clearTimeout(_resizeTO);
      _resizeTO = setTimeout(async () => {
        await renderAllPages();
      }, 200);
    });

    async function loadPdf() {
      try {
        overlay.classList.remove('hidden');
        setEnabled(false);
        pdfDoc = await pdfjsLib.getDocument(PDF_URL).promise;
        await renderAllPages();
        setEnabled(true);
      } catch (e) {
        console.error('PDF load error:', e);
        alert('Failed to load Admission.pdf from GitHub. Ensure the file is public and accessible at ' + PDF_URL);
        setEnabled(false);
      } finally {
        overlay.classList.add('hidden');
      }
    }

    (async function init() {
      // Load toolbar state
      const toolbarState = localStorage.getItem('toolbarState:' + fileKey);
      if (toolbarState === 'hidden') {
        toolbar.classList.add('hidden');
        toggleToolbarBtn.textContent = 'Show Toolbar';
      } else {
        toolbar.classList.add('expanded');
        toggleToolbarBtn.textContent = 'Hide Toolbar';
      }

      // Try to load anchors.json
      try {
        const p = await fetch('https://raw.githubusercontent.com/nuhadwrk/admission/main/anchors.json', { cache: 'no-store' });
        if (p.ok) {
          const j = await p.json();
          anchorsByPage = j.anchorsByPage || j;
        }
      } catch (e) {
        console.warn('No anchors.json found or failed to load:', e);
      }
      await loadPdf();
      // Initial mode setup
      fontSizeSel.disabled = modeSel.value !== 'design';
      lineHeightSel.disabled = modeSel.value !== 'design';
    })();
  </script>
</body>
</html>
